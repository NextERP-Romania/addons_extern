<?xml version="1.0" encoding="utf-8" ?>
<odoo>


        <template
        id="export_ubl_invoice_partner"
        inherit_id="account_edi_ubl_bis3.export_bis3_invoice_partner"
        primary="True"
        priority="100"
    >
            <xpath expr="//*[local-name()='PartyLegalEntity']/*[local-name()='CompanyID']" position="replace">
                <cbc:CompanyID
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                    t-if="partner_vals.get('legal_entity')"
                    t-esc="partner_vals['legal_entity']"/>
            </xpath>

            <xpath expr="//*[local-name()='CountrySubentity']" position="replace">
                <cbc:CountrySubentity
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                t-if="partner.state_id"
                t-esc="partner.state_id.country_id.code +'-'+ partner.state_id.code"
            />
            </xpath>


            <xpath expr="//*[local-name()='CityName']" position="replace">
                <t t-set="city" t-value="partner.city" />
                <t t-if="partner.state_id.code == 'B'">
                     <t t-set="city" t-value="partner.city.upper().replace(' ','')" />
                </t>
               <cbc:CityName
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
                t-if="city"
                t-esc="city"
            />
            </xpath>

            <xpath expr="//*[local-name()='PartyTaxScheme']" position="replace">
                <cac:PartyTaxScheme
                t-if="partner.vat"
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
            >
                    <cbc:CompanyID
                    t-esc="partner.vat"
                />
                    <cac:TaxScheme>
                        <t t-if="not partner.vat[:2].isdigit()"><cbc:ID>VAT</cbc:ID></t>
                    </cac:TaxScheme>
                </cac:PartyTaxScheme>


            </xpath>

        </template>



        <template
        id="export_cius_ro_invoice"
        inherit_id="account_edi_ubl_bis3.export_bis3_invoice"
        primary="True"
        priority="100"
    >

            <xpath
            expr="//*[local-name()='AccountingSupplierParty']"
            position="replace"
        >
                <cac:AccountingSupplierParty
                t-call="l10n_ro_edi_ubl.export_ubl_invoice_partner"
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
            >
                    <t t-set="partner_vals" t-value="supplier_vals" />
                </cac:AccountingSupplierParty>
            </xpath>
            <xpath
            expr="//*[local-name()='AccountingCustomerParty']"
            position="replace"
        >
                <cac:AccountingCustomerParty
                t-call="l10n_ro_edi_ubl.export_ubl_invoice_partner"
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
            >
                    <t t-set="partner_vals" t-value="customer_vals" />
                </cac:AccountingCustomerParty>
            </xpath>

            <xpath expr="//*[local-name()='PaymentMeans']/*[local-name()='PayeeFinancialAccount']" position="inside">
                <cac:FinancialInstitutionBranch t-if="record.partner_bank_id.bank_bic"
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
                        <cbc:ID><t t-esc="record.partner_bank_id.bank_bic"/></cbc:ID>
                </cac:FinancialInstitutionBranch>
            </xpath>
            <xpath
                expr="//*[local-name()='OrderReference']"
                position="replace"
            >
                <cac:OrderReference
                xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
                xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
                xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
            >
                    <cbc:ID><t t-esc="(record.ref or record.name)[:30]" /></cbc:ID>
                </cac:OrderReference>
            </xpath>

        </template>


</odoo>
